var GB;(function(GB){(function(State){var AbstractState=function(){function AbstractState(_template){this._template=_template;this._stateListeners=[]}AbstractState.prototype.init=function(container,onInitialized){this._container=container;this.layout(this.getStateData(),onInitialized)};AbstractState.prototype.requestLayout=function(){this.stop();this.layout(this.getStateData());this.start()};AbstractState.prototype.getStateData=function(){return null};AbstractState.prototype.start=function(){};AbstractState.prototype.stop=function(){};AbstractState.prototype.addStateListener=function(stateListener){this._stateListeners.push(stateListener)};AbstractState.prototype.removeStateListener=function(stateListener){var index=this._stateListeners.indexOf(stateListener);if(index>=0){this._stateListeners.splice(index,1)}};AbstractState.prototype.fireNewStateEvent=function(newState){for(var i=this._stateListeners.length;i>0;){i--;var stateListener=this._stateListeners[i];stateListener(this,newState)}};AbstractState.prototype.layout=function(data,onCompletion){var _this=this;while(this._container.firstChild){this._container.removeChild(this._container.firstChild)}this._template.transform(this._container,data,function(){_this.attach(_this._container);if(onCompletion){onCompletion()}})};AbstractState.prototype.attach=function(container){};AbstractState.prototype.fail=function(message,e){console.error(message);console.error(e)};return AbstractState}();State.AbstractState=AbstractState})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var __extends=this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}__.prototype=b.prototype;d.prototype=new __};var GB;(function(GB){(function(State){var AbstractLoopingState=function(_super){__extends(AbstractLoopingState,_super);function AbstractLoopingState(){_super.apply(this,arguments)}AbstractLoopingState.prototype.start=function(){var _this=this;var callUpdate=function(timestamp){var newState=null;if(_this._previousTimestamp){var diff=timestamp-_this._previousTimestamp;newState=_this.update(diff)}_this._previousTimestamp=timestamp;_this.render();if(newState!=null&&newState!=_this){_this.fireNewStateEvent(newState)}else{_this._animationFrameHandle=window.requestAnimationFrame(callUpdate)}};this.render();this._animationFrameHandle=window.requestAnimationFrame(callUpdate)};AbstractLoopingState.prototype.stop=function(){if(this._animationFrameHandle){window.cancelAnimationFrame(this._animationFrameHandle);this._animationFrameHandle=null}this._previousTimestamp=null};AbstractLoopingState.prototype.forceUpdate=function(){this.update(0);this.render()};AbstractLoopingState.prototype.update=function(updateMillis){return null};AbstractLoopingState.prototype.render=function(){};return AbstractLoopingState}(GB.State.AbstractState);State.AbstractLoopingState=AbstractLoopingState})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Home){var HomeData=function(){function HomeData(){}return HomeData}();Home.HomeData=HomeData})(State.Home||(State.Home={}));var Home=State.Home})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Home){var HomeState=function(_super){__extends(HomeState,_super);function HomeState(template,_playStateFactory,_audioContext){_super.call(this,template);this._playStateFactory=_playStateFactory;this._audioContext=_audioContext}HomeState.prototype.getStateData=function(){return new GB.State.Home.HomeData};HomeState.prototype.start=function(){var _this=this;document.getElementById("practise").onclick=function(){_this.play(true)};document.getElementById("play").onclick=function(){_this.play(false)};document.getElementById("test-audio").onclick=function(){_this.testAudio()}};HomeState.prototype.stop=function(){};HomeState.prototype.testAudio=function(){var oscillator=this._audioContext.createOscillator();oscillator.frequency.value=500;oscillator.connect(this._audioContext.destination);if(oscillator.noteOn){oscillator.noteOn(0)}else if(oscillator.start){oscillator.start(0)}if(oscillator.noteOff){oscillator.noteOff(2)}else if(oscillator.stop){oscillator.stop(2)}};HomeState.prototype.play=function(practise){var enableCompass;var disableCompassCheckbox=document.getElementById("disable-compass");if(disableCompassCheckbox.checked){enableCompass=false}else{enableCompass=null}var playState=this._playStateFactory(this,practise,enableCompass);this.fireNewStateEvent(playState)};return HomeState}(GB.State.AbstractState);Home.HomeState=HomeState})(State.Home||(State.Home={}));var Home=State.Home})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){var Level=function(){function Level(maxRange,_spawner,_player,_toneSequencer){this.maxRange=maxRange;this._spawner=_spawner;this._player=_player;this._toneSequencer=_toneSequencer;this._monsters=[];this.addMonster(this._player);this.age=0;this.kills=0;this.playerAlive=true}Level.prototype.getToneSequencer=function(){return this._toneSequencer};Level.prototype.canAddMonster=function(type){return this._toneSequencer.canAdd(type)};Level.prototype.addMonster=function(monster){this._monsters.push(monster);this._toneSequencer.add(monster.getType(),monster)};Level.prototype.getMonsters=function(){return this._monsters};Level.prototype.getPlayer=function(){return this._player};Level.prototype.update=function(ticks){this.age+=ticks;var players=0;var enemies=0;var newMonsters=this._spawner.spawn(this,ticks);for(var i=0;i<newMonsters.length;i++){var newMonster=newMonsters[i];this.addMonster(newMonster)}for(var i=this._monsters.length;i>0;){i--;var monster=this._monsters[i];monster.age(ticks);var mind=monster.getMind();if(!mind.think(monster,this,ticks)){this._monsters.splice(i,1);this.silenceMonster(monster)}else{if(monster.getType()==GB.State.Play.PlayState.MONSTER_TYPE_PLAYER){players++}else{enemies++}}}outer:for(var i=this._monsters.length;i>0;){i--;var monster=this._monsters[i];var monsterRadius=monster.getRadius();for(var j=i;j>0;){j--;var otherMonster=this._monsters[j];var otherMonsterRadius=otherMonster.getRadius();var dx=monster.getX()-otherMonster.getX();var dy=monster.getY()-otherMonster.getY();var dsq=dx*dx+dy*dy;var totalRadius=monsterRadius+otherMonsterRadius;var totalRadiusSq=totalRadius*totalRadius;if(totalRadiusSq>dsq){var removeMonster=!monster.getMind().handleCollision(monster,otherMonster,this);var removeOtherMonster=!otherMonster.getMind().handleCollision(otherMonster,monster,this);if(removeOtherMonster){this._monsters.splice(j,1);this.silenceMonster(otherMonster);i--}if(removeMonster){this._monsters.splice(i,1);this.silenceMonster(monster);continue outer}}}}this._toneSequencer.update(ticks,this);var result;if(this._spawner.isExpired(this)&&enemies==0){result=GB.State.Play.PlayState.RESULT_WON}else if(players==0){result=GB.State.Play.PlayState.RESULT_LOST;this.playerAlive=false}else{result=GB.State.Play.PlayState.RESULT_UNDECIDED}return result};Level.prototype.silence=function(){for(var i in this._monsters){var monster=this._monsters[i];this.silenceMonster(monster)}};Level.prototype.silenceMonster=function(monster){if(monster.tone){this._toneSequencer.remove(monster.getType(),monster)}};return Level}();Play.Level=Level})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Mind){var AbstractEnemyMind=function(){function AbstractEnemyMind(_explosionFactory,_summoningSicknessDuration,_deathDuration){this._explosionFactory=_explosionFactory;this._summoningSicknessDuration=_summoningSicknessDuration;this._deathDuration=_deathDuration}AbstractEnemyMind.prototype.think=function(monster,level,ticks){var state=monster.getState();if(state==GB.State.Play.PlayState.MONSTER_STATE_SPAWNED){var stateAge=monster.getStateAge();if(stateAge>this._summoningSicknessDuration){ticks=stateAge-this._summoningSicknessDuration;monster.setState(GB.State.Play.PlayState.MONSTER_STATE_NORMAL,ticks)}else{ticks=0}}else if(state==GB.State.Play.PlayState.MONSTER_STATE_DYING){var stateAge=monster.getStateAge();if(stateAge>this._deathDuration){return false}else{ticks=0}}if(ticks>0){return this.thinkFreely(monster,level,ticks)}else{return true}};AbstractEnemyMind.prototype.thinkFreely=function(monster,level,ticks){return true};AbstractEnemyMind.prototype.handleCollision=function(monster,withMonster,level){var withMonsterType=withMonster.getType();var dead=withMonsterType==GB.State.Play.PlayState.MONSTER_TYPE_BULLET;if(dead){if(this._explosionFactory){var explosion=this._explosionFactory(monster.getX(),monster.getY(),monster.getZ(),monster.getZAngle());level.addMonster(explosion)}level.kills++}return!dead};return AbstractEnemyMind}();Mind.AbstractEnemyMind=AbstractEnemyMind})(Play.Mind||(Play.Mind={}));var Mind=Play.Mind})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Mind){var DummyMind=function(_super){__extends(DummyMind,_super);function DummyMind(explosionFactory,summoningSicknessDuration,deathDuration,_speed){_super.call(this,explosionFactory,summoningSicknessDuration,deathDuration);this._speed=_speed}DummyMind.prototype.thinkFreely=function(monster,level,ticks){var sin=Math.sin(monster.getZAngle());var cos=Math.cos(monster.getZAngle());var d=Math.min(this._speed*ticks,monster.getRadius()*2);var dx=cos*d;var dy=sin*d;var x=monster.getX()+dx;var y=monster.getY()+dy;var dsq=x*x+y*y;monster.setPosition(x,y,0,dx/ticks,dy/ticks,0);return dsq<=level.maxRange*level.maxRange};return DummyMind}(GB.State.Play.Mind.AbstractEnemyMind);Mind.DummyMind=DummyMind})(Play.Mind||(Play.Mind={}));var Mind=Play.Mind})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Mind){var BulletMind=function(_super){__extends(BulletMind,_super);function BulletMind(summoningSicknessDuration,deathDuration,speed){_super.call(this,null,summoningSicknessDuration,deathDuration,speed)}BulletMind.prototype.handleCollision=function(monster,withMonster,level){var withMonsterType=withMonster.getType();return withMonsterType==GB.State.Play.PlayState.MONSTER_TYPE_BULLET||withMonsterType==GB.State.Play.PlayState.MONSTER_TYPE_PLAYER||withMonsterType==GB.State.Play.PlayState.MONSTER_TYPE_EXPLOSION};return BulletMind}(GB.State.Play.Mind.DummyMind);Mind.BulletMind=BulletMind})(Play.Mind||(Play.Mind={}));var Mind=Play.Mind})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Mind){var CreeperMind=function(_super){__extends(CreeperMind,_super);function CreeperMind(){_super.apply(this,arguments)}CreeperMind.prototype.thinkFreely=function(monster,level,ticks){var result;if(level.getToneSequencer().isPlaying(monster.getType(),monster)){result=_super.prototype.thinkFreely.call(this,monster,level,ticks)}else{result=true}return result};return CreeperMind}(GB.State.Play.Mind.DummyMind);Mind.CreeperMind=CreeperMind})(Play.Mind||(Play.Mind={}));var Mind=Play.Mind})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Mind){var ExplosionMind=function(){function ExplosionMind(_maxExplosionAge,_maxExplosionRadius){this._maxExplosionAge=_maxExplosionAge;this._maxExplosionRadius=_maxExplosionRadius}ExplosionMind.prototype.think=function(monster,level,ticks){var radius=this._maxExplosionRadius*monster.getAge()/this._maxExplosionAge;monster.setRadius(radius);return monster.getAge()<=this._maxExplosionAge};ExplosionMind.prototype.handleCollision=function(monster,withMonster,level){return true};return ExplosionMind}();Mind.ExplosionMind=ExplosionMind})(Play.Mind||(Play.Mind={}));var Mind=Play.Mind})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Mind){var PlayerInput=function(){function PlayerInput(){this._read=true;this._down=false}PlayerInput.prototype.read=function(){var read=this._read;this._read=true;return!read||this._down};PlayerInput.prototype.set=function(){this._down=true;this._read=false};PlayerInput.prototype.unset=function(){this._down=false};return PlayerInput}();Mind.PlayerInput=PlayerInput})(Play.Mind||(Play.Mind={}));var Mind=Play.Mind})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Mind){var PlayerMind=function(){function PlayerMind(_bulletFactory){this._bulletFactory=_bulletFactory;this._targetZAngle=0;this._inputs={}}PlayerMind.prototype.setTargetZAngle=function(targetZAngle){this._targetZAngle=targetZAngle};PlayerMind.prototype.setInput=function(inputKey){var input=this._inputs[inputKey];if(input==null){input=new GB.State.Play.Mind.PlayerInput;this._inputs[inputKey]=input}input.set()};PlayerMind.prototype.unsetInput=function(inputKey){var input=this._inputs[inputKey];if(input!=null){input.unset()}};PlayerMind.prototype.think=function(monster,level,ticks){monster.setZAngle(this._targetZAngle);var fireInput=this._inputs[GB.State.Play.PlayState.INPUT_FIRE];if(fireInput){if(fireInput.read()){if(level.canAddMonster(GB.State.Play.PlayState.MONSTER_TYPE_BULLET)){var angle=monster.getZAngle();var radius=monster.getRadius();var sin=Math.sin(angle);var cos=Math.cos(angle);var dx=cos*radius;var dy=sin*radius;var bullet=this._bulletFactory(monster.getX()+dx,monster.getY()+dy,monster.getZ(),monster.getZAngle());level.addMonster(bullet)}}}return true};PlayerMind.prototype.handleCollision=function(monster,withMonster,level){var withMonsterType=withMonster.getType();return withMonsterType==GB.State.Play.PlayState.MONSTER_TYPE_BULLET||withMonsterType==GB.State.Play.PlayState.MONSTER_TYPE_PLAYER||withMonsterType==GB.State.Play.PlayState.MONSTER_TYPE_EXPLOSION};return PlayerMind}();Mind.PlayerMind=PlayerMind})(Play.Mind||(Play.Mind={}));var Mind=Play.Mind})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Mind){var SpinningMind=function(_super){__extends(SpinningMind,_super);function SpinningMind(explosionFactory,summoningSicknessDuration,deathDuration,_orbitSpeed,_decaySpeed,_cw){_super.call(this,explosionFactory,summoningSicknessDuration,deathDuration);this._orbitSpeed=_orbitSpeed;this._decaySpeed=_decaySpeed;this._cw=_cw}SpinningMind.prototype.thinkFreely=function(monster,level,ticks){var x=monster.getX();var y=monster.getY();var r=Math.sqrt(x*x+y*y);var a=Math.atan2(y,x);var c=Math.PI*2*r;var dorbit=ticks*this._orbitSpeed;var dangle=dorbit*Math.PI*2/c;var tangle;var fangle;if(this._cw){tangle=a+dangle;fangle=tangle+Math.PI/2}else{tangle=a-dangle;fangle=tangle-Math.PI/2}var tr=r-this._decaySpeed*ticks;var tx=tr*Math.cos(tangle);var ty=tr*Math.sin(tangle);monster.setPosition(tx,ty,0,0,0,0);monster.setZAngle(fangle);return tr>monster.getRadius()};return SpinningMind}(GB.State.Play.Mind.AbstractEnemyMind);Mind.SpinningMind=SpinningMind})(Play.Mind||(Play.Mind={}));var Mind=Play.Mind})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){var Monster=function(){function Monster(_mind,tone,_type,_subtype,_state,_x,_y,_z,_zAngle,_radius){this._mind=_mind;this.tone=tone;this._type=_type;this._subtype=_subtype;this._state=_state;this._x=_x;this._y=_y;this._z=_z;this._zAngle=_zAngle;this._radius=_radius;this._age=0;this._stateAge=0;this._velocityX=0;this._velocityY=0;this._velocityZ=0}Monster.prototype.getRadius=function(){return this._radius};Monster.prototype.setRadius=function(radius){this._radius=radius};Monster.prototype.getX=function(){return this._x};Monster.prototype.getAge=function(){return this._age};Monster.prototype.getY=function(){return this._y};Monster.prototype.getZ=function(){return this._z};Monster.prototype.getVelocityX=function(){return this._velocityX};Monster.prototype.getVelocityY=function(){return this._velocityY};Monster.prototype.getVelocityZ=function(){return this._velocityZ};Monster.prototype.setPosition=function(x,y,z,vx,vy,vz){this._x=x;this._y=y;this._z=z;this._velocityX=vx;this._velocityY=vy;this._velocityZ=vz};Monster.prototype.getState=function(){return this._state};Monster.prototype.setState=function(state,stateAge){if(typeof stateAge==="undefined"){stateAge=0}this._state=state;this._stateAge=stateAge};Monster.prototype.getStateAge=function(){return this._stateAge};Monster.prototype.getZAngle=function(){return this._zAngle};Monster.prototype.setZAngle=function(zAngle){this._zAngle=zAngle};Monster.prototype.getMind=function(){return this._mind};Monster.prototype.getType=function(){return this._type};Monster.prototype.age=function(amount){this._age+=amount;this._stateAge+=amount};return Monster}();Play.Monster=Monster})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){var PlayData=function(){function PlayData(){}return PlayData}();Play.PlayData=PlayData})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){var PlayState=function(_super){__extends(PlayState,_super);function PlayState(template,_practise,_useCompass,_maxLines,levelFactory,_player,_oldState,_audioContext){var _this=this;_super.call(this,template);this._practise=_practise;this._useCompass=_useCompass;this._maxLines=_maxLines;this._player=_player;this._oldState=_oldState;this._audioContext=_audioContext;this._stopScrollingCallback=function(e){e.preventDefault()};this._hammerDragStartHandler=function(e){_this._hammerDragStartAngle=_this._player.getZAngle();var cx=window.innerWidth/2;var cy=_this._arenaDiameter/2;var sx=e.gesture.center.pageX;var sy=e.gesture.center.pageY;var dx=sx-cx;var dy=sy-cy;_this._hammerDragGrabAngle=Math.atan2(dy,dx)};this._hammerDragHandler=function(e){if(!_this._useCompass){var cx=window.innerWidth/2;var cy=_this._arenaDiameter/2;var sx=e.gesture.startEvent.center.pageX;var sy=e.gesture.startEvent.center.pageY;var ex=e.gesture.deltaX+sx;var ey=e.gesture.deltaY+sy;var dx=ex-cx;var dy=ey-cy;var hammerDragAngle=Math.atan2(dy,dx);var targetAngle=_this._hammerDragGrabAngle-hammerDragAngle+_this._hammerDragStartAngle;_this._playerMind.setTargetZAngle(targetAngle)}};this._hammerTapHandler=function(e){if(_this._level.playerAlive){_this._playerMind.setInput(PlayState.INPUT_FIRE);_this._playerMind.unsetInput(PlayState.INPUT_FIRE)}else{if((new Date).getTime()>_this._deathTime+5e3){_this.fireNewStateEvent(_this._oldState)}}};this._compassWatcher=function(heading){_this._playerMind.setTargetZAngle(heading*Math.PI/180)};var first=true;this._deviceOrientationWatcher=function(e){var alpha=e.alpha;if(alpha!=null&&e.absolute){_this._useCompass=true;if(first){window.removeEventListener("deviceorientation",_this._deviceOrientationWatcher);setTimeout(function(){window.addEventListener("deviceorientation",_this._deviceOrientationWatcher)},100);first=false}_this._playerMind.setTargetZAngle((360-alpha)*Math.PI/180)}};this._playerMind=this._player.getMind();this._level=levelFactory(this._player)}PlayState.prototype.start=function(){var _this=this;$(window).on("touchmove",this._stopScrollingCallback);this._hammer=new Hammer(document,{drag:true,transform:false,swipe:false,tap:true});this._hammer.on("drag",this._hammerDragHandler);this._hammer.on("dragstart",this._hammerDragStartHandler);this._hammer.on("tap",this._hammerTapHandler);var disableCompass=function(){if(_this._useCompass==null){_this._useCompass=false}};if(this._useCompass!=false){Compass.needGPS(disableCompass).needMove(disableCompass).init(function(enabled){if(_this._useCompass==null&&enabled){_this._useCompass=true;_this._compassWatchId=Compass.watch(_this._compassWatcher)}});window.addEventListener("deviceorientation",this._deviceOrientationWatcher)}this._arenaCanvas=document.getElementById("play-arena");this._arenaContext=this._arenaCanvas.getContext("2d");this._arenaGradient=this._arenaContext.createRadialGradient(0,0,this._arenaDiameter/4,0,0,this._arenaDiameter/2);this._arenaGradient.addColorStop(0,"#ffffff");this._arenaGradient.addColorStop(1,"#000000");this._arenaContext.translate(this._arenaDiameter/2,this._arenaDiameter/2);_super.prototype.start.call(this)};PlayState.prototype.stop=function(){$(window).off("touchmove",this._stopScrollingCallback);this._hammer.off("drag",this._hammerDragHandler);this._hammer.off("dragstart",this._hammerDragStartHandler);this._hammer.off("dragend",this._hammerTapHandler);this._hammer.off("tap",this._hammerTapHandler);this._level.silence();if(this._compassWatchId!=null){Compass.unwatch(this._compassWatchId);this._compassWatchId=null}window.removeEventListener("deviceorientation",this._deviceOrientationWatcher);_super.prototype.stop.call(this)};PlayState.prototype.getStateData=function(){var width=window.innerWidth;var height=window.innerHeight;this._arenaDiameter=Math.min(width,height);var data=new GB.State.Play.PlayData;data.arenaDiameter=this._arenaDiameter;return data};PlayState.prototype.render=function(){this._arenaContext.fillStyle="#000000";this._arenaContext.fillRect(-this._arenaDiameter/2,-this._arenaDiameter/2,this._arenaDiameter,this._arenaDiameter);var zAngle=-this._player.getZAngle()-Math.PI/2;this._arenaContext.rotate(zAngle);var toneSequencer=this._level.getToneSequencer();this._arenaContext.strokeStyle=this._arenaGradient;this._arenaContext.lineWidth=1;this._arenaContext.globalAlpha=.5;for(var x=0;x<this._maxLines;x++){var ax=(x+1)*this._arenaDiameter/(this._maxLines+1)-this._arenaDiameter/2;this._arenaContext.beginPath();this._arenaContext.moveTo(ax,-this._arenaDiameter/2);this._arenaContext.lineTo(ax,this._arenaDiameter/2);this._arenaContext.stroke()}for(var y=0;y<this._maxLines;y++){var ay=(y+1)*this._arenaDiameter/(this._maxLines+1)-this._arenaDiameter/2;this._arenaContext.beginPath();this._arenaContext.moveTo(-this._arenaDiameter/2,ay);this._arenaContext.lineTo(this._arenaDiameter/2,ay);this._arenaContext.stroke()}this._arenaContext.globalAlpha=1;if(this._practise||!this._level.playerAlive){var scale=this._arenaDiameter/(this._level.maxRange*2);var monsters=this._level.getMonsters();for(var i in monsters){var monster=monsters[i];this._arenaContext.strokeStyle="#ffffff";var mr=scale*monster.getRadius();var mx=scale*(monster.getX()-this._player.getX());var my=scale*(monster.getY()-this._player.getY());var zangle=monster.getZAngle();this._arenaContext.translate(mx,my);this._arenaContext.beginPath();var fill;var stroke;var type=monster.getType();switch(type){case PlayState.MONSTER_TYPE_CREEPER:this._arenaContext.rotate(zangle);this._arenaContext.moveTo(mr,0);this._arenaContext.lineTo(-mr,-mr/1.4);this._arenaContext.lineTo(-mr,mr/1.4);this._arenaContext.rotate(-zangle);this._arenaContext.closePath();fill="#00f";stroke="#aaf";break;case PlayState.MONSTER_TYPE_DUMMY:this._arenaContext.rotate(-zAngle);var h=Math.sin(monster.getAge()/500)*mr/2+mr;this._arenaContext.moveTo(mr,0);this._arenaContext.lineTo(0,-h);this._arenaContext.lineTo(-mr,0);this._arenaContext.lineTo(0,h);this._arenaContext.closePath();this._arenaContext.rotate(zAngle);fill="#0f0";stroke="#afa";break;case PlayState.MONSTER_TYPE_SPINNER:var rangle=monster.getAge()*Math.PI/1e3;this._arenaContext.rotate(rangle);this._arenaContext.moveTo(mr,0);this._arenaContext.lineTo(mr/4,-mr/4);this._arenaContext.lineTo(0,-mr);this._arenaContext.lineTo(-mr/4,-mr/4);this._arenaContext.lineTo(-mr,0);this._arenaContext.lineTo(-mr/4,mr/4);this._arenaContext.lineTo(0,mr);this._arenaContext.lineTo(mr/4,mr/4);this._arenaContext.closePath();this._arenaContext.rotate(-rangle);fill="#b0b";stroke="#faf";break;case PlayState.MONSTER_TYPE_AMBULANCE:this._arenaContext.rotate(zangle);this._arenaContext.moveTo(mr,mr);this._arenaContext.lineTo(-mr,mr);this._arenaContext.lineTo(-mr,-mr);this._arenaContext.lineTo(mr,-mr);this._arenaContext.closePath();this._arenaContext.rotate(-zangle);fill="#f00";stroke="#faa";break;case PlayState.MONSTER_TYPE_BULLET:this._arenaContext.rotate(zangle);this._arenaContext.moveTo(mr,0);this._arenaContext.lineTo(-mr,-mr/2);this._arenaContext.lineTo(-mr,mr/2);this._arenaContext.closePath();this._arenaContext.rotate(-zangle);stroke="#ff0";fill=null;break;case PlayState.MONSTER_TYPE_PLAYER:this._arenaContext.rotate(zangle);this._arenaContext.moveTo(mr,0);this._arenaContext.lineTo(-mr/2,-mr);this._arenaContext.lineTo(-mr,-mr/2);this._arenaContext.lineTo(-mr,mr/2);this._arenaContext.lineTo(-mr/2,mr);this._arenaContext.closePath();this._arenaContext.rotate(-zangle);stroke="#fff";fill=null;break;default:this._arenaContext.moveTo(mr,0);this._arenaContext.arc(0,0,mr,0,Math.PI*2);fill=null;stroke="#fff";break}if(fill&&(toneSequencer.isPlaying(monster.getType(),monster)||!this._level.playerAlive)){this._arenaContext.globalAlpha=.4;this._arenaContext.fillStyle=fill;this._arenaContext.fill();this._arenaContext.globalAlpha=1}this._arenaContext.strokeStyle=stroke;this._arenaContext.stroke();this._arenaContext.translate(-mx,-my)}}this._arenaContext.rotate(-zAngle);if(!this._practise){var fontSize=Math.floor(this._arenaDiameter/15);this._arenaContext.font=fontSize+"px Arial";this._arenaContext.fillStyle="#fff";this._arenaContext.textAlign="left";this._arenaContext.fillText("KILLS "+this._level.kills,-this._arenaDiameter/2,this._arenaDiameter/2-fontSize);var seconds=Math.floor(this._level.age/1e3);this._arenaContext.textAlign="right";this._arenaContext.fillText("TIME "+seconds,this._arenaDiameter/2,this._arenaDiameter/2-fontSize)}if(!this._level.playerAlive){var fontSize=Math.floor(this._arenaDiameter/15);this._arenaContext.font=fontSize+"px Arial";this._arenaContext.fillStyle="#fff";this._arenaContext.textAlign="left";var text="YOU DEFEATED";var fm=this._arenaContext.measureText(text);this._arenaContext.fillText(text,-fm.width/2,-this._arenaDiameter/2+fontSize)}else if(this._useCompass){var fontSize=Math.floor(this._arenaDiameter/30);this._arenaContext.font=fontSize+"px Arial";this._arenaContext.fillStyle="#fff";this._arenaContext.textAlign="left";this._arenaContext.fillText("compass on",-this._arenaDiameter/2,-this._arenaDiameter/2+fontSize)}};PlayState.prototype.update=function(updateMillis){var result;if(this._level.playerAlive){var levelResult=this._level.update(updateMillis);if(levelResult==PlayState.RESULT_LOST){result=null;this._level.silence();this._deathTime=(new Date).getTime()}else if(levelResult==PlayState.RESULT_WON){result=this._oldState}else{result=null}}return result};PlayState.MONSTER_TYPE_PLAYER=0;PlayState.MONSTER_TYPE_DUMMY=1;PlayState.MONSTER_TYPE_BULLET=2;PlayState.MONSTER_TYPE_EXPLOSION=3;PlayState.MONSTER_TYPE_CREEPER=4;PlayState.MONSTER_TYPE_SPINNER=5;PlayState.MONSTER_TYPE_AMBULANCE=6;PlayState.MONSTER_TYPE_PLAYER_SUBTYPE_P1=0;PlayState.MONSTER_TYPE_DUMMY_SUBTYPE_NORMAL=0;PlayState.MONSTER_TYPE_BULLET_SUBTYPE_NORMAL=0;PlayState.MONSTER_TYPE_EXPLOSION_SUBTYPE_NORMAL=0;PlayState.MONSTER_TYPE_CREEPER_SUBTYPE_NORMAL=0;PlayState.MONSTER_TYPE_SPINNER_SUBTYPE_NORMAL=0;PlayState.MONSTER_TYPE_AMBULANCE_SUBTYPE_NORMAL=0;PlayState.RESULT_UNDECIDED=0;PlayState.RESULT_LOST=1;PlayState.RESULT_WON=2;PlayState.MONSTER_STATE_SPAWNED=0;PlayState.MONSTER_STATE_NORMAL=1;PlayState.MONSTER_STATE_DYING=2;PlayState.INPUT_FIRE="fire";return PlayState}(GB.State.AbstractLoopingState);Play.PlayState=PlayState})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Spawner){var RandomSpawner=function(){function RandomSpawner(_difficulty,_maxDifficulty,_minRadius,_maxRadius,_weights,_maxDuration){this._difficulty=_difficulty;this._maxDifficulty=_maxDifficulty;this._minRadius=_minRadius;this._maxRadius=_maxRadius;this._weights=_weights;this._maxDuration=_maxDuration;this._heat=0}RandomSpawner.prototype.isExpired=function(level){return this._maxDuration!=null&&level.age>this._maxDuration};RandomSpawner.prototype.getProgress=function(level){return Math.min(this._maxDifficulty,Math.sqrt(level.age/1e3)/this._difficulty)};RandomSpawner.prototype.spawn=function(level,delta){var result=[];var progress=this.getProgress(level);this._heat+=delta*progress/1e3;if(this._heat>1){var totalWeight=0;for(var i in this._weights){var weight=this._weights[i];var maxQuantity=weight.maxQuantityMultiplier*level.age;if(maxQuantity>=1){totalWeight+=weight.weight}}var monsterWeight=Math.random()*totalWeight*progress;for(var i in this._weights){var weight=this._weights[i];var maxQuantity=weight.maxQuantityMultiplier*level.age;if(maxQuantity>=1){monsterWeight-=weight.weight}if(monsterWeight<=0){var quantity=1;while(quantity>0&&this._heat>0&&level.canAddMonster(weight.type)){this._heat-=weight.coolDownValue;quantity--;var aggression=Math.pow(Math.max(1,progress),1.2);var mind=weight.mindFactory(aggression);var r=this._minRadius+(this._maxRadius-this._minRadius)*Math.random();var a=Math.PI*2*Math.random();var mx=Math.cos(a)*r;var my=Math.sin(a)*r;var mz=0;var tone=weight.toneFactory();var monster=new GB.State.Play.Monster(mind,tone,weight.type,weight.subtype,GB.State.Play.PlayState.MONSTER_STATE_SPAWNED,mx,my,mz,a-Math.PI,7);result.push(monster)}break}}}return result};return RandomSpawner}();Spawner.RandomSpawner=RandomSpawner})(Play.Spawner||(Play.Spawner={}));var Spawner=Play.Spawner})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Spawner){var RandomSpawnerWeight=function(){function RandomSpawnerWeight(weight,coolDownValue,maxQuantityMultiplier,type,subtype,mindFactory,toneFactory){this.weight=weight;this.coolDownValue=coolDownValue;this.maxQuantityMultiplier=maxQuantityMultiplier;this.type=type;this.subtype=subtype;this.mindFactory=mindFactory;this.toneFactory=toneFactory}return RandomSpawnerWeight}();Spawner.RandomSpawnerWeight=RandomSpawnerWeight})(Play.Spawner||(Play.Spawner={}));var Spawner=Play.Spawner})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Tone){var NoTone=function(){function NoTone(duration){this.duration=duration}NoTone.prototype.play=function(when,times){};NoTone.prototype.stop=function(when){};NoTone.prototype.destroy=function(when){};NoTone.prototype.setPosition=function(x,y,z,vx,vy,vz,level){};return NoTone}();Tone.NoTone=NoTone})(Play.Tone||(Play.Tone={}));var Tone=Play.Tone})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Tone){var OneShotToneProxy=function(){function OneShotToneProxy(_toneFactory,duration){this._toneFactory=_toneFactory;this.duration=duration;this._activeTones=[]}OneShotToneProxy.prototype.play=function(when,times){this._currentTone=this._toneFactory();this._activeTones.push(this._currentTone);if(this._level!=null){this._currentTone.setPosition(this._x,this._y,this._z,this._vx,this._vy,this._vz,this._level)}this._currentTone.play(when,times)};OneShotToneProxy.prototype.stop=function(when){if(this._currentTone){this._currentTone.stop(when);this._currentTone=null}};OneShotToneProxy.prototype.destroy=function(when){for(var i in this._activeTones){var activeTone=this._activeTones[i];
activeTone.destroy(when)}this._activeTones=null};OneShotToneProxy.prototype.setPosition=function(x,y,z,vx,vy,vz,level){this._x=x;this._y=y;this._z=z;this._vx=vx;this._vy=vy;this._vz=vz;this._level=level;for(var i in this._activeTones){var activeTone=this._activeTones[i];activeTone.setPosition(x,y,z,vx,vy,vz,level)}};return OneShotToneProxy}();Tone.OneShotToneProxy=OneShotToneProxy})(Play.Tone||(Play.Tone={}));var Tone=Play.Tone})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Tone){var WebAudioManualPannerTone=function(){function WebAudioManualPannerTone(_target,duration,_gainLeft,_gainRight,_top,_sources){this._target=_target;this.duration=duration;this._gainLeft=_gainLeft;this._gainRight=_gainRight;this._top=_top;this._sources=_sources;this._started=false}WebAudioManualPannerTone.prototype.play=function(when,times){if(!this._started){for(var i in this._sources){var source=this._sources[i];if(source.noteOn){source.noteOn(when/1e3)}else if(source.start){source.start(when/1e3)}}this._started=true}this._top.connect(this._target);if(times){this.stop(times*this.duration+when)}};WebAudioManualPannerTone.prototype.stop=function(when){var _this=this;for(var i in this._sources){var source=this._sources[i];try{if(source.noteOff){source.noteOff(when/1e3)}else if(source.stop){source.stop(when/1e3)}}catch(e){}}setTimeout(function(){try{_this._top.disconnect()}catch(e){}},when)};WebAudioManualPannerTone.prototype.destroy=function(when){this.stop(when)};WebAudioManualPannerTone.prototype.setPosition=function(x,y,z,vx,vy,vz,level){var dsq=x*x+y*y;var vsqrt=1-Math.sqrt(dsq)/level.maxRange;var v=Math.max(vsqrt*vsqrt,0);var a=Math.atan2(y,x);var c1=Math.abs(Math.sin(Math.PI/4+a/2));var c2=Math.abs(Math.sin(Math.PI/4-a/2));this._gainRight.gain.value=c1*v;this._gainLeft.gain.value=c2*v};return WebAudioManualPannerTone}();Tone.WebAudioManualPannerTone=WebAudioManualPannerTone})(Play.Tone||(Play.Tone={}));var Tone=Play.Tone})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Tone){var WebAudioManualPannerToneProxy=function(){function WebAudioManualPannerToneProxy(attackTimeSeconds,attackVolume,decayTimeSeconds,decayVolume,fadeTimeSeconds,_audioContext,_proxiedSource,_proxied){this.attackTimeSeconds=attackTimeSeconds;this.attackVolume=attackVolume;this.decayTimeSeconds=decayTimeSeconds;this.decayVolume=decayVolume;this.fadeTimeSeconds=fadeTimeSeconds;this._audioContext=_audioContext;this._proxiedSource=_proxiedSource;this._proxied=_proxied;this._gainLeft=_audioContext.createGainNode();this._gainLeft.gain.value=1;_proxiedSource.connect(this._gainLeft);this._gainRight=_audioContext.createGainNode();this._gainRight.gain.value=1;_proxiedSource.connect(this._gainRight);this._merger=_audioContext.createChannelMerger(2);this._gainLeft.connect(this._merger,0,0);this._gainRight.connect(this._merger,0,1);this._gain=_audioContext.createGainNode();this._gain.gain.value=0;this._merger.connect(this._gain)}WebAudioManualPannerToneProxy.prototype.getSource=function(){return this._gain};WebAudioManualPannerToneProxy.prototype.play=function(when,times){var now=this._audioContext.currentTime;this._gain.gain.cancelScheduledValues(now);this._gain.gain.setValueAtTime(this._gain.gain.value,now);this._gain.gain.linearRampToValueAtTime(this.attackVolume,now+this.attackTimeSeconds);this._gain.gain.linearRampToValueAtTime(this.decayVolume,now+this.attackTimeSeconds+this.decayTimeSeconds);if(this._proxied){this._proxied.play(when,times)}};WebAudioManualPannerToneProxy.prototype.stop=function(when){var now=this._audioContext.currentTime;this._gain.gain.cancelScheduledValues(0);this._gain.gain.setValueAtTime(this._gain.gain.value,now);this._gain.gain.linearRampToValueAtTime(0,now+this.fadeTimeSeconds);if(this._proxied){this._proxied.stop(when)}};WebAudioManualPannerToneProxy.prototype.destroy=function(when){if(this._proxied){this._proxied.destroy(when)}this._gain.disconnect()};WebAudioManualPannerToneProxy.prototype.setPosition=function(x,y,z,vx,vy,vz,level){var dsq=x*x+y*y;var vsqrt=1-Math.sqrt(dsq)/level.maxRange;var v=Math.pow(vsqrt,1.5);var a=Math.atan2(y,x);var c1=Math.abs(Math.sin(Math.PI/4+a/2));var c2=Math.abs(Math.sin(Math.PI/4-a/2));this._gainRight.gain.value=c1*v;this._gainLeft.gain.value=c2*v};return WebAudioManualPannerToneProxy}();Tone.WebAudioManualPannerToneProxy=WebAudioManualPannerToneProxy})(Play.Tone||(Play.Tone={}));var Tone=Play.Tone})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){(function(Tone){var WebAudioSynthTone=function(){function WebAudioSynthTone(frequency,oscillatorType,lfoType,lfoFrequency,osciFOGain,_audioContext){this.frequency=frequency;this.oscillatorType=oscillatorType;this.lfoType=lfoType;this.lfoFrequency=lfoFrequency;this.osciFOGain=osciFOGain;this._audioContext=_audioContext;this._oscillator=_audioContext.createOscillator();this._oscillator.frequency.value=frequency;this._oscillator.type=oscillatorType;if(this._oscillator.noteOn){this._oscillator.noteOn(0)}else if(this._oscillator.start){this._oscillator.start(0)}this._filter=_audioContext.createBiquadFilter();this._filter.frequency.value=5e3;this._filter.type=0;this._oscillator.connect(this._filter);this._lfo=_audioContext.createOscillator();this._lfo.type=lfoType;this._lfo.frequency.value=lfoFrequency;if(this._lfo.noteOn){this._lfo.noteOn(0)}else if(this._lfo.start){this._lfo.start(0)}this._osciFOGain=_audioContext.createGainNode();this._osciFOGain.gain.value=osciFOGain;this._lfo.connect(this._osciFOGain);this._osciFOGain.connect(this._oscillator.detune)}WebAudioSynthTone.prototype.getSource=function(){return this._filter};WebAudioSynthTone.prototype.setFilterFrequency=function(filterFrequency){var now=this._audioContext.currentTime;var minValue=40;var maxValue=44100/2;var numberOfOctaves=Math.log(maxValue/minValue)/Math.LN2;var multiplier=Math.pow(2,numberOfOctaves*(filterFrequency-1));this._filter.frequency.setValueAtTime(maxValue*multiplier,now)};WebAudioSynthTone.prototype.setFilterResonance=function(filterResonance){var now=this._audioContext.currentTime;this._filter.Q.setValueAtTime(filterResonance*30,now)};WebAudioSynthTone.prototype.play=function(when,times){};WebAudioSynthTone.prototype.stop=function(when){};WebAudioSynthTone.prototype.destroy=function(when){if(this._oscillator.noteOff){this._oscillator.noteOff(0)}else if(this._oscillator.stop){this._oscillator.stop(0)}if(this._lfo.noteOff){this._lfo.noteOff(0)}else if(this._oscillator.stop){this._lfo.stop(0)}this._filter.disconnect()};WebAudioSynthTone.prototype.setPosition=function(x,y,z,vx,vy,vz,level){};return WebAudioSynthTone}();Tone.WebAudioSynthTone=WebAudioSynthTone})(Play.Tone||(Play.Tone={}));var Tone=Play.Tone})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){var ToneSequencer=function(){function ToneSequencer(_bars){this._bars=_bars;this._uncontrolledMonsters=[]}ToneSequencer.prototype.canAdd=function(barId){var bar=this._bars[barId];var result;if(bar!=null){result=false;for(var i in bar.monsters){var monster=bar.monsters[i];if(monster==null){result=true;break}}}else{result=false}return result};ToneSequencer.prototype.add=function(barId,monster){var bar=this._bars[barId];if(bar!=null){for(var i in bar.monsters){var existingMonster=bar.monsters[i];if(existingMonster==null){bar.monsters[i]=monster;if(i==bar.index){monster.tone.play(0)}break}}}else{monster.tone.play(0);this._uncontrolledMonsters.push(monster)}};ToneSequencer.prototype.remove=function(barId,monster){var bar=this._bars[barId];if(bar!=null){var index=bar.monsters.indexOf(monster);if(index>=0){monster.tone.destroy(0);bar.monsters[index]=null}}else{monster.tone.destroy(0);var index=this._uncontrolledMonsters.indexOf(monster);if(index>=0){this._uncontrolledMonsters.splice(index,1)}}};ToneSequencer.prototype.isPlaying=function(barId,monster){var bar=this._bars[barId];var result;if(bar!=null){var index=bar.monsters.indexOf(monster);result=index==bar.index}else{result=false}return result};ToneSequencer.prototype.update=function(millis,level){var player=level.getPlayer();var playerX=player.getX();var playerY=player.getY();var playerZ=player.getZ();var playerAngleZ=player.getZAngle();var playerAngleZSin=Math.sin(-playerAngleZ);var playerAngleZCos=Math.cos(-playerAngleZ);for(var barId in this._bars){var bar=this._bars[barId];var remainder=level.age%bar.totalDuration;var index=Math.ceil(remainder/bar.toneDuration)%bar.size;var monster;if(index!=bar.index){var toneRemainder=remainder%bar.toneDuration;var previousMonster=bar.monsters[bar.index];if(previousMonster!=null){previousMonster.tone.stop(toneRemainder)}bar.index=index;monster=bar.monsters[index];if(monster!=null){monster.tone.play(toneRemainder)}}else{monster=bar.monsters[index]}if(monster!=null){var x=monster.getX()-playerX;var y=monster.getY()-playerY;var rx=x*playerAngleZCos-y*playerAngleZSin;var ry=x*playerAngleZSin+y*playerAngleZCos;monster.tone.setPosition(rx,ry,playerZ,0,0,0,level)}}for(var i in this._uncontrolledMonsters){var monster=this._uncontrolledMonsters[i];var x=monster.getX()-playerX;var y=monster.getY()-playerY;var rx=x*playerAngleZCos-y*playerAngleZSin;var ry=x*playerAngleZSin+y*playerAngleZCos;monster.tone.setPosition(rx,ry,playerZ,0,0,0,level)}};return ToneSequencer}();Play.ToneSequencer=ToneSequencer})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){(function(Play){var ToneSequencerBar=function(){function ToneSequencerBar(size,toneDuration){this.size=size;this.toneDuration=toneDuration;this.monsters=[];for(var i=0;i<size;i++){this.monsters.push(null)}this.index=null;this.totalDuration=toneDuration*size}return ToneSequencerBar}();Play.ToneSequencerBar=ToneSequencerBar})(State.Play||(State.Play={}));var Play=State.Play})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(State){var StateEngine=function(){function StateEngine(_container){var _this=this;this._container=_container;this._stateListener=function(oldState,newState){if(oldState!=newState){_this.setCurrentState(newState)}};window.onresize=function(){if(_this._currentState){_this._currentState.requestLayout()}}}StateEngine.prototype.setCurrentState=function(currentState){var _this=this;if(this._currentState){this._currentState.removeStateListener(this._stateListener);this._currentState.stop()}this._currentState=currentState;if(this._currentState){this._currentState.addStateListener(this._stateListener);this._currentState.init(this._container,function(){_this._currentState.start()})}};return StateEngine}();State.StateEngine=StateEngine})(GB.State||(GB.State={}));var State=GB.State})(GB||(GB={}));var GB;(function(GB){(function(Transformer){function createTransformerFactoryFromString(transformerFactory,templateString){return function(){return transformerFactory.createTransformerFromString(templateString)}}Transformer.createTransformerFactoryFromString=createTransformerFactoryFromString})(GB.Transformer||(GB.Transformer={}));var Transformer=GB.Transformer})(GB||(GB={}));var GB;(function(GB){(function(Transformer){(function(XSL){var StandardXSLTransformer=function(){function StandardXSLTransformer(_xsltProcessor,_toXMLTransformer,_document){this._xsltProcessor=_xsltProcessor;this._toXMLTransformer=_toXMLTransformer;this._document=_document}StandardXSLTransformer.prototype.setParameter=function(key,value){var parameterValue;if(value instanceof Array){parameterValue="";var first=true;for(var i in value){var v=value[i];if(first){first=false}else{parameterValue+=","}parameterValue+=v}}else{parameterValue=value}this._xsltProcessor.setParameter(null,key,parameterValue)};StandardXSLTransformer.prototype.transform=function(into,data,onCompletion){var xml=this._toXMLTransformer(data);if(xml==null){xml=this._document.createElement("null")}var output=this._xsltProcessor.transformToFragment(xml,this._document);into.appendChild(output);if(onCompletion){onCompletion()}};return StandardXSLTransformer}();XSL.StandardXSLTransformer=StandardXSLTransformer})(Transformer.XSL||(Transformer.XSL={}));var XSL=Transformer.XSL})(GB.Transformer||(GB.Transformer={}));var Transformer=GB.Transformer})(GB||(GB={}));var GB;(function(GB){(function(Transformer){(function(XSL){var StandardXSLTransformerFactory=function(){function StandardXSLTransformerFactory(_domParser,_document,_toXMLTransformer){this._domParser=_domParser;this._document=_document;this._toXMLTransformer=_toXMLTransformer}StandardXSLTransformerFactory.prototype.preprocess=function(path,node,onSuccess,onFailure){onSuccess()};StandardXSLTransformerFactory.prototype.createTransformerFromString=function(template){var xslNode=this._domParser.parseFromString(template,"text/xml");var transformer=this.createTransformerFromNode(xslNode);return transformer};StandardXSLTransformerFactory.prototype.createTransformerFromNode=function(xsl){var xsltProcessor=new XSLTProcessor;xsltProcessor.importStylesheet(xsl);return new GB.Transformer.XSL.StandardXSLTransformer(xsltProcessor,this._toXMLTransformer,this._document)};return StandardXSLTransformerFactory}();XSL.StandardXSLTransformerFactory=StandardXSLTransformerFactory})(Transformer.XSL||(Transformer.XSL={}));var XSL=Transformer.XSL})(GB.Transformer||(GB.Transformer={}));var Transformer=GB.Transformer})(GB||(GB={}));var GB;(function(GB){(function(Util){function removeFromArray(t,a){var result=false;for(var i=a.length;i>0;){i--;var e=a[i];if(e==t){a.splice(i,1);result=true;break}}return result}Util.removeFromArray=removeFromArray})(GB.Util||(GB.Util={}));var Util=GB.Util})(GB||(GB={}));var GB;(function(GB){(function(Util){function getClassName(o){var funcNameRegex=/function (.{1,})\(/;var results=funcNameRegex.exec(o.constructor.toString());return results&&results.length>1?results[1]:null}Util.getClassName=getClassName})(GB.Util||(GB.Util={}));var Util=GB.Util})(GB||(GB={}));var GB;(function(GB){(function(Util){function readXML(path,onSuccess,onFailure){var xhr=new XMLHttpRequest;xhr.onload=function(){onSuccess(xhr.responseXML)};xhr.onerror=function(e){onFailure(e)};xhr.open("GET",path,true);xhr.send(null)}Util.readXML=readXML;function toXML(o,name,filter,indexNames,tab,indent,index,indexDepth){if(name==null&&o!=null){name=GB.Util.getClassName(o)}var xml;var type=typeof o;var isFunction=type=="function";if(name!=null&&!isFunction){var isArray=o instanceof Array;var isLiteral=type=="number"||type=="string"||type=="boolean";var isUndefined=type=="undefined"&&!isArray;var encloseInTags=!isArray||indexDepth!=null;if(tab==null){tab="	"}if(indent==null){indent=""}xml=indent;if(encloseInTags){xml+="<"+name;if(index!=null){if(indexNames!=null){var names=indexNames[name];if(names!=null&&names.length>indexDepth){var indexName=names[indexDepth];xml+=" "+indexName+'="'+index+'"'}}}}if(isUndefined){xml+="/>\n"}else{if(encloseInTags){xml+=">"}if(isLiteral){xml+=o}else{xml+="\n";if(indexDepth==null){indexDepth=0}else{indexDepth++}for(var i in o){if(filter==null||filter(o,i)){var e=o[i];var s;if(isArray){s=toXML(e,name,filter,indexNames,tab,indent+tab,i,indexDepth)}else{if(i!="prototype"){var propertyName=i;if(propertyName.indexOf("_")==0){propertyName=propertyName.substring(1)}s=toXML(e,propertyName,filter,indexNames,tab,indent+tab)}else{s=null}}if(s!=null){xml+=s}}}xml+=indent}if(encloseInTags){xml+="</"+name+">\n"}}}else{xml=null}return xml}Util.toXML=toXML})(GB.Util||(GB.Util={}));var Util=GB.Util})(GB||(GB={}));window.onload=function(){if(!window.requestAnimationFrame){window.requestAnimationFrame=window["webkitRequestAnimationFrame"]||window["mozRequestAnimationFrame"]||function(callback){return window.setTimeout(callback,1e3/60)}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=window["webkitCancelAnimationFrame"]||window["mozCancelAnimationFrame"]||function(handle){return window.clearTimeout(handle)}}var audioContext;if(window["AudioContext"]){audioContext=new AudioContext}else if(window["webkitAudioContext"]){audioContext=new webkitAudioContext}if(!audioContext.createGainNode){audioContext.createGainNode=audioContext.createGain}var domParser=new DOMParser;var toXMLTransformer=function(t){var xml=GB.Util.toXML(t);var result;if(xml!=null){result=domParser.parseFromString(xml,"text/xml")}else{result=null}return result};var xslTransformerFactory=new GB.Transformer.XSL.StandardXSLTransformerFactory(domParser,document,toXMLTransformer);var playTemplate=document.getElementById("play-template").innerHTML;var playTransformer=GB.Transformer.createTransformerFactoryFromString(xslTransformerFactory,playTemplate)();var beatDuration=1e3;var explosionToneDuration=beatDuration;var explosionToneFactory=function(){var attackTime=explosionToneDuration/(1e3*8);var decayTime=explosionToneDuration/1e3;var releaseTime=explosionToneDuration/1e3;var oscillator=audioContext.createOscillator();oscillator.frequency.value=100;var staticNode=audioContext.createJavaScriptNode(1024,1,1);staticNode.onaudioprocess=function(ev){var out=ev.outputBuffer.getChannelData(0);for(var i=0;i<out.length;i++){out[i]=Math.random()*2-1}};oscillator.connect(staticNode);var proxy=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(attackTime,1,decayTime,0,releaseTime,audioContext,staticNode);proxy.getSource().connect(audioContext.destination);return proxy};var bulletToneDuration=beatDuration;var bulletToneFactory=function(){try{var attackTime=.1;var decayTime=bulletToneDuration/1e3;var releaseTime=.2;var frequency=Math.random()*100+350;var lfoFrequency=6.19;var lfoGain=-500;var filterFrequency=.8;var filterResonance=.38;var tone=new GB.State.Play.Tone.WebAudioSynthTone(frequency,2,2,lfoFrequency,lfoGain,audioContext);tone.setFilterFrequency(filterFrequency);tone.setFilterResonance(filterResonance);var proxy=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(attackTime,.3,decayTime,.25,releaseTime,audioContext,tone.getSource(),tone);proxy.getSource().connect(audioContext.destination);return proxy}catch(e){window.alert(""+e);return null}};var dummyToneDuration=beatDuration;var dummyToneFactory=function(){var attackTime=dummyToneDuration/(1e3*4);var decayTime=dummyToneDuration/1e3;var releaseTime=dummyToneDuration/(1e3*4);var frequency=Math.random()*140+200;var lfoFrequency=3.19;var lfoGain=-500;var filterFrequency=1;var filterResonance=.38;var tone=new GB.State.Play.Tone.WebAudioSynthTone(frequency,0,0,lfoFrequency,lfoGain,audioContext);tone.setFilterFrequency(filterFrequency);tone.setFilterResonance(filterResonance);var proxy=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(attackTime,1,decayTime,.9,releaseTime,audioContext,tone.getSource(),tone);proxy.getSource().connect(audioContext.destination);return proxy};var creeperToneDuration=beatDuration*1.5;var creeperToneFactory=function(){var attackTime=creeperToneDuration/(1e3*4);var decayTime=creeperToneDuration/1e3;var releaseTime=creeperToneDuration/(1e3*4);var frequency=Math.random()*100+100;var lfoFrequency=9.19;var lfoGain=-500;var filterFrequency=.5;var filterResonance=.2;var tone=new GB.State.Play.Tone.WebAudioSynthTone(frequency,3,2,lfoFrequency,lfoGain,audioContext);tone.setFilterFrequency(filterFrequency);tone.setFilterResonance(filterResonance);var proxy=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(attackTime,1,decayTime,.9,releaseTime,audioContext,tone.getSource(),tone);proxy.getSource().connect(audioContext.destination);return proxy};var spinnerToneDuration=beatDuration*.33;var spinnerToneFactory=function(){var attackTime=spinnerToneDuration/(1e3*4);var decayTime=spinnerToneDuration/1e3;var releaseTime=spinnerToneDuration/(1e3*4);var frequency=Math.random()*150+800;var lfoFrequency=15;var lfoGain=-500;var filterFrequency=.5;var filterResonance=.2;var tone=new GB.State.Play.Tone.WebAudioSynthTone(frequency,3,2,lfoFrequency,lfoGain,audioContext);tone.setFilterFrequency(filterFrequency);tone.setFilterResonance(filterResonance);var proxy=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(attackTime,.4,decayTime,.2,releaseTime,audioContext,tone.getSource(),tone);proxy.getSource().connect(audioContext.destination);return proxy};var ambulanceToneDuration=beatDuration*.75;var ambulanceToneFactory=function(){var attackTime=ambulanceToneDuration/(1e3*4);var decayTime=ambulanceToneDuration/1e3;var releaseTime=ambulanceToneDuration/(1e3*4);var frequency=Math.random()*200+600;var lfoFrequency=2;var lfoGain=-500;var filterFrequency=.5;var filterResonance=.2;var tone=new GB.State.Play.Tone.WebAudioSynthTone(frequency,2,1,lfoFrequency,lfoGain,audioContext);tone.setFilterFrequency(filterFrequency);tone.setFilterResonance(filterResonance);var proxy=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(attackTime,.6,decayTime,.5,releaseTime,audioContext,tone.getSource(),tone);proxy.getSource().connect(audioContext.destination);return proxy};var playStateFactory=function(oldState,practise,enableCompass){var explosionMind=new GB.State.Play.Mind.ExplosionMind(explosionToneDuration,30);var explosionFactory=function(x,y,z,zAngle){var explosion=new GB.State.Play.Monster(explosionMind,explosionToneFactory(),GB.State.Play.PlayState.MONSTER_TYPE_EXPLOSION,GB.State.Play.PlayState.MONSTER_TYPE_EXPLOSION_SUBTYPE_NORMAL,GB.State.Play.PlayState.MONSTER_STATE_NORMAL,x,y,z,zAngle,0);return explosion};var bulletMind=new GB.State.Play.Mind.BulletMind(0,0,.1);var bulletFactory=function(x,y,z,zAngle){var bullet=new GB.State.Play.Monster(bulletMind,bulletToneFactory(),GB.State.Play.PlayState.MONSTER_TYPE_BULLET,GB.State.Play.PlayState.MONSTER_TYPE_BULLET_SUBTYPE_NORMAL,GB.State.Play.PlayState.MONSTER_STATE_NORMAL,x,y,z,zAngle,3);return bullet};var playerMind=new GB.State.Play.Mind.PlayerMind(bulletFactory);var levelFactory=function(player){var weights=[];weights.push(new GB.State.Play.Spawner.RandomSpawnerWeight(40,4,1,GB.State.Play.PlayState.MONSTER_TYPE_CREEPER,GB.State.Play.PlayState.MONSTER_TYPE_CREEPER_SUBTYPE_NORMAL,function(aggression){return new GB.State.Play.Mind.CreeperMind(explosionFactory,2e3,1e3,.003*aggression)},creeperToneFactory));weights.push(new GB.State.Play.Spawner.RandomSpawnerWeight(20,6,1,GB.State.Play.PlayState.MONSTER_TYPE_DUMMY,GB.State.Play.PlayState.MONSTER_TYPE_DUMMY_SUBTYPE_NORMAL,function(aggression){return new GB.State.Play.Mind.DummyMind(explosionFactory,2e3,1e3,.002*aggression)},dummyToneFactory));weights.push(new GB.State.Play.Spawner.RandomSpawnerWeight(10,10,1,GB.State.Play.PlayState.MONSTER_TYPE_SPINNER,GB.State.Play.PlayState.MONSTER_TYPE_SPINNER_SUBTYPE_NORMAL,function(agression){return new GB.State.Play.Mind.SpinningMind(explosionFactory,2e3,1e3,.01*agression,.001*agression,Math.random()>.5)},spinnerToneFactory));weights.push(new GB.State.Play.Spawner.RandomSpawnerWeight(5,20,1,GB.State.Play.PlayState.MONSTER_TYPE_AMBULANCE,GB.State.Play.PlayState.MONSTER_TYPE_AMBULANCE_SUBTYPE_NORMAL,function(aggression){return new GB.State.Play.Mind.DummyMind(explosionFactory,5e3,1e3,.005*aggression)},ambulanceToneFactory));var spawner=new GB.State.Play.Spawner.RandomSpawner(10,5,70,95,weights);var bars={};bars[GB.State.Play.PlayState.MONSTER_TYPE_DUMMY]=new GB.State.Play.ToneSequencerBar(2,dummyToneDuration);bars[GB.State.Play.PlayState.MONSTER_TYPE_BULLET]=new GB.State.Play.ToneSequencerBar(1,bulletToneDuration);bars[GB.State.Play.PlayState.MONSTER_TYPE_CREEPER]=new GB.State.Play.ToneSequencerBar(4,creeperToneDuration);bars[GB.State.Play.PlayState.MONSTER_TYPE_SPINNER]=new GB.State.Play.ToneSequencerBar(1,spinnerToneDuration);bars[GB.State.Play.PlayState.MONSTER_TYPE_AMBULANCE]=new GB.State.Play.ToneSequencerBar(2,ambulanceToneDuration);var level=new GB.State.Play.Level(100,spawner,player,new GB.State.Play.ToneSequencer(bars));return level};var player=new GB.State.Play.Monster(playerMind,new GB.State.Play.Tone.NoTone(beatDuration),GB.State.Play.PlayState.MONSTER_TYPE_PLAYER,GB.State.Play.PlayState.MONSTER_TYPE_PLAYER_SUBTYPE_P1,GB.State.Play.PlayState.MONSTER_STATE_NORMAL,0,0,0,0,5);var playState=new GB.State.Play.PlayState(playTransformer,practise,enableCompass,6,levelFactory,player,oldState,audioContext);return playState};var homeTemplate=document.getElementById("home-template").innerHTML;var homeTransformer=GB.Transformer.createTransformerFactoryFromString(xslTransformerFactory,homeTemplate)();var homeState=new GB.State.Home.HomeState(homeTransformer,playStateFactory,audioContext);var content=document.getElementById("content");var stateEngine=new GB.State.StateEngine(content);stateEngine.setCurrentState(homeState)};