var GB;!function(a){!function(a){var b=function(){function a(a){this._template=a,this._stateListeners=[]}return a.prototype.init=function(a,b){this._container=a,this.layout(this.getStateData(),b)},a.prototype.requestLayout=function(){this.stop(),this.layout(this.getStateData()),this.start()},a.prototype.getStateData=function(){return null},a.prototype.start=function(){},a.prototype.stop=function(){},a.prototype.addStateListener=function(a){this._stateListeners.push(a)},a.prototype.removeStateListener=function(a){var b=this._stateListeners.indexOf(a);b>=0&&this._stateListeners.splice(b,1)},a.prototype.fireNewStateEvent=function(a){for(var b=this._stateListeners.length;b>0;){b--;var c=this._stateListeners[b];c(this,a)}},a.prototype.layout=function(a,b){for(var c=this;this._container.firstChild;)this._container.removeChild(this._container.firstChild);this._template.transform(this._container,a,function(){c.attach(c._container),b&&b()})},a.prototype.attach=function(){},a.prototype.fail=function(a,b){console.error(a),console.error(b)},a}();a.AbstractState=b}(a.State||(a.State={}));a.State}(GB||(GB={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},GB;!function(a){!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.start=function(){var a=this,b=function(c){var d=null;if(a._previousTimestamp){var e=c-a._previousTimestamp;d=a.update(e)}a._previousTimestamp=c,a.render(),null!=d&&d!=a?a.fireNewStateEvent(d):a._animationFrameHandle=window.requestAnimationFrame(b)};this.render(),this._animationFrameHandle=window.requestAnimationFrame(b)},b.prototype.stop=function(){this._animationFrameHandle&&(window.cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=null),this._previousTimestamp=null},b.prototype.forceUpdate=function(){this.update(0),this.render()},b.prototype.update=function(){return null},b.prototype.render=function(){},b}(a.State.AbstractState);b.AbstractLoopingState=c}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){var b=function(){function a(){}return a}();a.HomeData=b}(a.Home||(a.Home={}));a.Home}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){var c=function(b){function c(a,c,d){b.call(this,a),this._playStateFactory=c,this._audioContext=d}return __extends(c,b),c.prototype.getStateData=function(){return new a.State.Home.HomeData},c.prototype.start=function(){var a=this;document.getElementById("practise").onclick=function(){a.play(!0)},document.getElementById("play").onclick=function(){a.play(!1)},document.getElementById("test-audio").onclick=function(){a.testAudio()}},c.prototype.stop=function(){},c.prototype.testAudio=function(){var a=this._audioContext.createOscillator();a.frequency.value=500,a.connect(this._audioContext.destination),a.noteOn?a.noteOn(0):a.start&&a.start(0),a.noteOff?a.noteOff(2):a.stop&&a.stop(2)},c.prototype.play=function(a){var b=this._playStateFactory(this,a);this.fireNewStateEvent(b)},c}(a.State.AbstractState);b.HomeState=c}(b.Home||(b.Home={}));b.Home}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){var c=function(){function b(a,b,c,d){this.maxRange=a,this._spawner=b,this._player=c,this._toneSequencer=d,this._monsters=[],this.addMonster(this._player),this.age=0,this.kills=0,this.playerAlive=!0}return b.prototype.getToneSequencer=function(){return this._toneSequencer},b.prototype.canAddMonster=function(a){return this._toneSequencer.canAdd(a)},b.prototype.addMonster=function(a){this._monsters.push(a),this._toneSequencer.add(a.getType(),a)},b.prototype.getMonsters=function(){return this._monsters},b.prototype.getPlayer=function(){return this._player},b.prototype.update=function(b){this.age+=b;for(var c=0,d=0,e=this._spawner.spawn(this,b),f=0;f<e.length;f++){var g=e[f];this.addMonster(g)}for(var f=this._monsters.length;f>0;){f--;var h=this._monsters[f];h.age(b);var i=h.getMind();i.think(h,this,b)?h.getType()==a.State.Play.PlayState.MONSTER_TYPE_PLAYER?c++:d++:(this._monsters.splice(f,1),this.silenceMonster(h))}a:for(var f=this._monsters.length;f>0;){f--;for(var h=this._monsters[f],j=h.getRadius(),k=f;k>0;){k--;var l=this._monsters[k],m=l.getRadius(),n=h.getX()-l.getX(),o=h.getY()-l.getY(),p=n*n+o*o,q=j+m,r=q*q;if(r>p){var s=!h.getMind().handleCollision(h,l,this),t=!l.getMind().handleCollision(l,h,this);if(t&&(this._monsters.splice(k,1),this.silenceMonster(l),f--),s){this._monsters.splice(f,1),this.silenceMonster(h);continue a}}}}this._toneSequencer.update(b,this);var u;return this._spawner.isExpired(this)&&0==d?u=a.State.Play.PlayState.RESULT_WON:0==c?(u=a.State.Play.PlayState.RESULT_LOST,this.playerAlive=!1):u=a.State.Play.PlayState.RESULT_UNDECIDED,u},b.prototype.silence=function(){for(var a in this._monsters){var b=this._monsters[a];this.silenceMonster(b)}},b.prototype.silenceMonster=function(a){a.tone&&this._toneSequencer.remove(a.getType(),a)},b}();b.Level=c}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){!function(b){var c=function(){function b(a,b,c){this._explosionFactory=a,this._summoningSicknessDuration=b,this._deathDuration=c}return b.prototype.think=function(b,c,d){var e=b.getState();if(e==a.State.Play.PlayState.MONSTER_STATE_SPAWNED){var f=b.getStateAge();f>this._summoningSicknessDuration?(d=f-this._summoningSicknessDuration,b.setState(a.State.Play.PlayState.MONSTER_STATE_NORMAL,d)):d=0}else if(e==a.State.Play.PlayState.MONSTER_STATE_DYING){var f=b.getStateAge();if(f>this._deathDuration)return!1;d=0}return d>0?this.thinkFreely(b,c,d):!0},b.prototype.thinkFreely=function(){return!0},b.prototype.handleCollision=function(b,c,d){var e=c.getType(),f=e==a.State.Play.PlayState.MONSTER_TYPE_BULLET;if(f){if(this._explosionFactory){var g=this._explosionFactory(b.getX(),b.getY(),b.getZ(),b.getZAngle());d.addMonster(g)}d.kills++}return!f},b}();b.AbstractEnemyMind=c}(b.Mind||(b.Mind={}));b.Mind}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){!function(b){var c=function(a){function b(b,c,d,e){a.call(this,b,c,d),this._speed=e}return __extends(b,a),b.prototype.thinkFreely=function(a,b,c){var d=Math.sin(a.getZAngle()),e=Math.cos(a.getZAngle()),f=Math.min(this._speed*c,2*a.getRadius()),g=e*f,h=d*f,i=a.getX()+g,j=a.getY()+h,k=i*i+j*j;return a.setPosition(i,j,0,g/c,h/c,0),k<=b.maxRange*b.maxRange},b}(a.State.Play.Mind.AbstractEnemyMind);b.DummyMind=c}(b.Mind||(b.Mind={}));b.Mind}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){!function(b){var c=function(b){function c(a,c,d){b.call(this,null,a,c,d)}return __extends(c,b),c.prototype.handleCollision=function(b,c){var d=c.getType();return d==a.State.Play.PlayState.MONSTER_TYPE_BULLET||d==a.State.Play.PlayState.MONSTER_TYPE_PLAYER||d==a.State.Play.PlayState.MONSTER_TYPE_EXPLOSION},c}(a.State.Play.Mind.DummyMind);b.BulletMind=c}(b.Mind||(b.Mind={}));b.Mind}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.thinkFreely=function(b,c,d){var e;return e=c.getToneSequencer().isPlaying(b.getType(),b)?a.prototype.thinkFreely.call(this,b,c,d):!0},b}(a.State.Play.Mind.DummyMind);b.CreeperMind=c}(b.Mind||(b.Mind={}));b.Mind}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){!function(a){var b=function(){function a(a,b){this._maxExplosionAge=a,this._maxExplosionRadius=b}return a.prototype.think=function(a){var b=this._maxExplosionRadius*a.getAge()/this._maxExplosionAge;return a.setRadius(b),a.getAge()<=this._maxExplosionAge},a.prototype.handleCollision=function(){return!0},a}();a.ExplosionMind=b}(a.Mind||(a.Mind={}));a.Mind}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){!function(a){var b=function(){function a(){this._read=!0,this._down=!1}return a.prototype.read=function(){var a=this._read;return this._read=!0,!a||this._down},a.prototype.set=function(){this._down=!0,this._read=!1},a.prototype.unset=function(){this._down=!1},a}();a.PlayerInput=b}(a.Mind||(a.Mind={}));a.Mind}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){!function(b){var c=function(){function b(a){this._bulletFactory=a,this._targetZAngle=0,this._inputs={}}return b.prototype.setTargetZAngle=function(a){this._targetZAngle=a},b.prototype.setInput=function(b){var c=this._inputs[b];null==c&&(c=new a.State.Play.Mind.PlayerInput,this._inputs[b]=c),c.set()},b.prototype.unsetInput=function(a){var b=this._inputs[a];null!=b&&b.unset()},b.prototype.think=function(b,c){b.setZAngle(this._targetZAngle);var d=this._inputs[a.State.Play.PlayState.INPUT_FIRE];if(d&&d.read()){var e=b.getZAngle(),f=b.getRadius(),g=Math.sin(e),h=Math.cos(e),i=h*f,j=g*f,k=this._bulletFactory(b.getX()+i,b.getY()+j,b.getZ(),b.getZAngle());c.canAddMonster(k.getType())&&c.addMonster(k)}return!0},b.prototype.handleCollision=function(b,c){var d=c.getType();return d==a.State.Play.PlayState.MONSTER_TYPE_BULLET||d==a.State.Play.PlayState.MONSTER_TYPE_PLAYER||d==a.State.Play.PlayState.MONSTER_TYPE_EXPLOSION},b}();b.PlayerMind=c}(b.Mind||(b.Mind={}));b.Mind}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){!function(b){var c=function(a){function b(b,c,d,e,f,g){a.call(this,b,c,d),this._orbitSpeed=e,this._decaySpeed=f,this._cw=g}return __extends(b,a),b.prototype.thinkFreely=function(a,b,c){var d,e,f=a.getX(),g=a.getY(),h=Math.sqrt(f*f+g*g),i=Math.atan2(g,f),j=2*Math.PI*h,k=c*this._orbitSpeed,l=k*Math.PI*2/j;this._cw?(d=i+l,e=d+Math.PI/2):(d=i-l,e=d-Math.PI/2);var m=h-this._decaySpeed*c,n=m*Math.cos(d),o=m*Math.sin(d);return a.setPosition(n,o,0,0,0,0),a.setZAngle(e),m>a.getRadius()},b}(a.State.Play.Mind.AbstractEnemyMind);b.SpinningMind=c}(b.Mind||(b.Mind={}));b.Mind}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){var b=function(){function a(a,b,c,d,e,f,g,h,i,j){this._mind=a,this.tone=b,this._type=c,this._subtype=d,this._state=e,this._x=f,this._y=g,this._z=h,this._zAngle=i,this._radius=j,this._age=0,this._stateAge=0,this._velocityX=0,this._velocityY=0,this._velocityZ=0}return a.prototype.getRadius=function(){return this._radius},a.prototype.setRadius=function(a){this._radius=a},a.prototype.getX=function(){return this._x},a.prototype.getAge=function(){return this._age},a.prototype.getY=function(){return this._y},a.prototype.getZ=function(){return this._z},a.prototype.getVelocityX=function(){return this._velocityX},a.prototype.getVelocityY=function(){return this._velocityY},a.prototype.getVelocityZ=function(){return this._velocityZ},a.prototype.setPosition=function(a,b,c,d,e,f){this._x=a,this._y=b,this._z=c,this._velocityX=d,this._velocityY=e,this._velocityZ=f},a.prototype.getState=function(){return this._state},a.prototype.setState=function(a,b){"undefined"==typeof b&&(b=0),this._state=a,this._stateAge=b},a.prototype.getStateAge=function(){return this._stateAge},a.prototype.getZAngle=function(){return this._zAngle},a.prototype.setZAngle=function(a){this._zAngle=a},a.prototype.getMind=function(){return this._mind},a.prototype.getType=function(){return this._type},a.prototype.age=function(a){this._age+=a,this._stateAge+=a},a}();a.Monster=b}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){var b=function(){function a(){}return a}();a.PlayData=b}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){var c=function(b){function c(a,d,e,f,g,h,i){var j=this;b.call(this,a),this._practise=d,this._maxLines=e,this._player=g,this._oldState=h,this._audioContext=i,this._stopScrollingCallback=function(a){a.preventDefault()},this._hammerDragStartHandler=function(a){j._hammerDragStartAngle=j._player.getZAngle();var b=window.innerWidth/2,c=j._arenaDiameter/2,d=a.gesture.center.pageX,e=a.gesture.center.pageY,f=d-b,g=e-c;j._hammerDragGrabAngle=Math.atan2(g,f)},this._hammerDragHandler=function(a){var b=window.innerWidth/2,c=j._arenaDiameter/2,d=a.gesture.startEvent.center.pageX,e=a.gesture.startEvent.center.pageY,f=a.gesture.deltaX+d,g=a.gesture.deltaY+e,h=f-b,i=g-c,k=Math.atan2(i,h),l=j._hammerDragGrabAngle-k+j._hammerDragStartAngle;j._playerMind.setTargetZAngle(l)},this._hammerTapHandler=function(){j._level.playerAlive?(j._playerMind.setInput(c.INPUT_FIRE),j._playerMind.unsetInput(c.INPUT_FIRE),j.forceUpdate()):(new Date).getTime()>j._deathTime+5e3&&j.fireNewStateEvent(j._oldState)},this._playerMind=this._player.getMind(),this._level=f(this._player)}return __extends(c,b),c.prototype.start=function(){$(window).on("touchmove",this._stopScrollingCallback),this._hammer=new Hammer(document,{drag:!0,transform:!1,swipe:!1,tap:!0}),this._hammer.on("drag",this._hammerDragHandler),this._hammer.on("dragstart",this._hammerDragStartHandler),this._hammer.on("dragend",this._hammerTapHandler),this._hammer.on("tap",this._hammerTapHandler),this._arenaCanvas=document.getElementById("play-arena"),this._arenaContext=this._arenaCanvas.getContext("2d"),this._arenaGradient=this._arenaContext.createRadialGradient(0,0,this._arenaDiameter/4,0,0,this._arenaDiameter/2),this._arenaGradient.addColorStop(0,"#ffffff"),this._arenaGradient.addColorStop(1,"#000000"),this._arenaContext.translate(this._arenaDiameter/2,this._arenaDiameter/2),b.prototype.start.call(this)},c.prototype.stop=function(){$(window).off("touchmove",this._stopScrollingCallback),this._hammer.off("drag",this._hammerDragHandler),this._hammer.off("dragstart",this._hammerDragStartHandler),this._hammer.off("dragend",this._hammerTapHandler),this._hammer.off("tap",this._hammerTapHandler),this._level.silence(),b.prototype.stop.call(this)},c.prototype.getStateData=function(){var b=window.innerWidth,c=window.innerHeight;this._arenaDiameter=Math.min(b,c);var d=new a.State.Play.PlayData;return d.arenaDiameter=this._arenaDiameter,d},c.prototype.render=function(){this._arenaContext.fillStyle="#000000",this._arenaContext.fillRect(-this._arenaDiameter/2,-this._arenaDiameter/2,this._arenaDiameter,this._arenaDiameter);var a=-this._player.getZAngle()-Math.PI/2;this._arenaContext.rotate(a);var b=this._level.getToneSequencer();this._arenaContext.strokeStyle=this._arenaGradient,this._arenaContext.lineWidth=1,this._arenaContext.globalAlpha=.5;for(var d=0;d<this._maxLines;d++){var e=(d+1)*this._arenaDiameter/(this._maxLines+1)-this._arenaDiameter/2;this._arenaContext.beginPath(),this._arenaContext.moveTo(e,-this._arenaDiameter/2),this._arenaContext.lineTo(e,this._arenaDiameter/2),this._arenaContext.stroke()}for(var f=0;f<this._maxLines;f++){var g=(f+1)*this._arenaDiameter/(this._maxLines+1)-this._arenaDiameter/2;this._arenaContext.beginPath(),this._arenaContext.moveTo(-this._arenaDiameter/2,g),this._arenaContext.lineTo(this._arenaDiameter/2,g),this._arenaContext.stroke()}if(this._arenaContext.globalAlpha=1,this._practise||!this._level.playerAlive){var h=this._arenaDiameter/(2*this._level.maxRange),i=this._level.getMonsters();for(var j in i){var k=i[j];this._arenaContext.strokeStyle="#ffffff";var l=h*k.getRadius(),m=h*(k.getX()-this._player.getX()),n=h*(k.getY()-this._player.getY()),o=Math.sin(k.getZAngle()),p=Math.cos(k.getZAngle());if(this._arenaContext.beginPath(),this._arenaContext.moveTo(m+l,n),this._arenaContext.arc(m,n,l,0,2*Math.PI),this._arenaContext.stroke(),b.isPlaying(k.getType(),k)||!this._level.playerAlive){var q,r=k.getType();switch(r){case c.MONSTER_TYPE_CREEPER:q="#00f";break;case c.MONSTER_TYPE_DUMMY:q="#0f0";break;case c.MONSTER_TYPE_SPINNER:q="#f00";break;default:q="#000"}this._arenaContext.fillStyle=q,this._arenaContext.fill()}this._arenaContext.beginPath(),this._arenaContext.moveTo(m+l*p,n+l*o),this._arenaContext.lineTo(m,n),this._arenaContext.stroke()}}this._arenaContext.rotate(-a);var s=Math.floor(this._arenaDiameter/15);if(!this._practise){this._arenaContext.font=s+"px Arial",this._arenaContext.fillStyle="#fff",this._arenaContext.textAlign="left",this._arenaContext.fillText("KILLS "+this._level.kills,-this._arenaDiameter/2,this._arenaDiameter/2-s);var t=Math.floor(this._level.age/1e3);this._arenaContext.textAlign="right",this._arenaContext.fillText("TIME "+t,this._arenaDiameter/2,this._arenaDiameter/2-s)}if(!this._level.playerAlive){this._arenaContext.font=s+"px Arial",this._arenaContext.fillStyle="#fff",this._arenaContext.textAlign="left";var u="YOU DEFEATED",v=this._arenaContext.measureText(u);this._arenaContext.fillText(u,-v.width/2,-this._arenaDiameter/2+s)}},c.prototype.update=function(a){var b;if(this._level.playerAlive){var d=this._level.update(a);d==c.RESULT_LOST?(b=null,this._level.silence(),this._deathTime=(new Date).getTime()):b=d==c.RESULT_WON?this._oldState:null}return b},c.MONSTER_TYPE_PLAYER=0,c.MONSTER_TYPE_DUMMY=1,c.MONSTER_TYPE_BULLET=2,c.MONSTER_TYPE_EXPLOSION=3,c.MONSTER_TYPE_CREEPER=4,c.MONSTER_TYPE_SPINNER=5,c.MONSTER_TYPE_PLAYER_SUBTYPE_P1=0,c.MONSTER_TYPE_DUMMY_SUBTYPE_NORMAL=0,c.MONSTER_TYPE_BULLET_SUBTYPE_NORMAL=0,c.MONSTER_TYPE_EXPLOSION_SUBTYPE_NORMAL=0,c.MONSTER_TYPE_CREEPER_SUBTYPE_NORMAL=0,c.MONSTER_TYPE_SPINNER_SUBTYPE_NORMAL=0,c.RESULT_UNDECIDED=0,c.RESULT_LOST=1,c.RESULT_WON=2,c.MONSTER_STATE_SPAWNED=0,c.MONSTER_STATE_NORMAL=1,c.MONSTER_STATE_DYING=2,c.INPUT_FIRE="fire",c}(a.State.AbstractLoopingState);b.PlayState=c}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){!function(b){var c=function(){function b(a,b,c,d,e){this._difficulty=a,this._minRadius=b,this._maxRadius=c,this._weights=d,this._maxDuration=e,this._heat=0}return b.prototype.isExpired=function(a){return null!=this._maxDuration&&a.age>this._maxDuration},b.prototype.spawn=function(b,c){var d=[],e=Math.min(1,Math.sqrt(b.age/1e3)/this._difficulty);if(this._heat+=c*e/1e3,this._heat>1){var f=0;for(var g in this._weights){var h=this._weights[g],i=h.maxQuantityMultiplier*b.age;i>=1&&(f+=h.weight)}var j=Math.random()*f*e;for(var g in this._weights){var h=this._weights[g],i=h.maxQuantityMultiplier*b.age;if(i>=1&&(j-=h.weight),0>=j){for(var k=1;k>0&&this._heat>0&&b.canAddMonster(h.type);){this._heat-=h.coolDownValue;var l=h.mindFactory(),m=this._minRadius+(this._maxRadius-this._minRadius)*Math.random(),n=2*Math.PI*Math.random(),o=Math.cos(n)*m,p=Math.sin(n)*m,q=0,r=h.toneFactory(),s=new a.State.Play.Monster(l,r,h.type,h.subtype,a.State.Play.PlayState.MONSTER_STATE_SPAWNED,o,p,q,n-Math.PI,7);d.push(s)}break}}}return d},b}();b.RandomSpawner=c}(b.Spawner||(b.Spawner={}));b.Spawner}(b.Play||(b.Play={}));b.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){!function(a){var b=function(){function a(a,b,c,d,e,f,g){this.weight=a,this.coolDownValue=b,this.maxQuantityMultiplier=c,this.type=d,this.subtype=e,this.mindFactory=f,this.toneFactory=g}return a}();a.RandomSpawnerWeight=b}(a.Spawner||(a.Spawner={}));a.Spawner}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){!function(a){var b=function(){function a(a){this.duration=a}return a.prototype.play=function(){},a.prototype.stop=function(){},a.prototype.destroy=function(){},a.prototype.setPosition=function(){},a}();a.NoTone=b}(a.Tone||(a.Tone={}));a.Tone}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){!function(a){var b=function(){function a(a,b){this._toneFactory=a,this.duration=b,this._activeTones=[]}return a.prototype.play=function(a,b){this._currentTone=this._toneFactory(),this._activeTones.push(this._currentTone),null!=this._level&&this._currentTone.setPosition(this._x,this._y,this._z,this._vx,this._vy,this._vz,this._level),this._currentTone.play(a,b)},a.prototype.stop=function(a){this._currentTone&&(this._currentTone.stop(a),this._currentTone=null)},a.prototype.destroy=function(a){for(var b in this._activeTones){var c=this._activeTones[b];c.destroy(a)}this._activeTones=null},a.prototype.setPosition=function(a,b,c,d,e,f,g){this._x=a,this._y=b,this._z=c,this._vx=d,this._vy=e,this._vz=f,this._level=g;for(var h in this._activeTones){var i=this._activeTones[h];i.setPosition(a,b,c,d,e,f,g)}},a}();a.OneShotToneProxy=b}(a.Tone||(a.Tone={}));a.Tone}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){!function(a){var b=function(){function a(a,b,c,d,e,f){this._target=a,this.duration=b,this._gainLeft=c,this._gainRight=d,this._top=e,this._sources=f,this._started=!1}return a.prototype.play=function(a,b){if(!this._started){for(var c in this._sources){var d=this._sources[c];d.noteOn?d.noteOn(a/1e3):d.start&&d.start(a/1e3)}this._started=!0}this._top.connect(this._target),b&&this.stop(b*this.duration+a)},a.prototype.stop=function(a){var b=this;for(var c in this._sources){var d=this._sources[c];try{d.noteOff?d.noteOff(a/1e3):d.stop&&d.stop(a/1e3)}catch(e){}}setTimeout(function(){try{b._top.disconnect()}catch(a){}},a)},a.prototype.destroy=function(a){this.stop(a)},a.prototype.setPosition=function(a,b,c,d,e,f,g){var h=a*a+b*b,i=1-Math.sqrt(h)/g.maxRange,j=Math.max(i*i,0),k=Math.atan2(b,a),l=Math.abs(Math.sin(Math.PI/4+k/2)),m=Math.abs(Math.sin(Math.PI/4-k/2));this._gainRight.gain.value=l*j,this._gainLeft.gain.value=m*j},a}();a.WebAudioManualPannerTone=b}(a.Tone||(a.Tone={}));a.Tone}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){!function(a){var b=function(){function a(a,b,c,d,e,f,g,h){this.attackTimeSeconds=a,this.attackVolume=b,this.decayTimeSeconds=c,this.decayVolume=d,this.fadeTimeSeconds=e,this._audioContext=f,this._proxiedSource=g,this._proxied=h,this._gainLeft=f.createGainNode(),this._gainLeft.gain.value=1,g.connect(this._gainLeft),this._gainRight=f.createGainNode(),this._gainRight.gain.value=1,g.connect(this._gainRight),this._merger=f.createChannelMerger(2),this._gainLeft.connect(this._merger,0,0),this._gainRight.connect(this._merger,0,1),this._gain=f.createGainNode(),this._gain.gain.value=0,this._merger.connect(this._gain)}return a.prototype.getSource=function(){return this._gain},a.prototype.play=function(a,b){var c=this._audioContext.currentTime;this._gain.gain.cancelScheduledValues(c),this._gain.gain.setValueAtTime(this._gain.gain.value,c),this._gain.gain.linearRampToValueAtTime(this.attackVolume,c+this.attackTimeSeconds),this._gain.gain.linearRampToValueAtTime(this.decayVolume,c+this.attackTimeSeconds+this.decayTimeSeconds),this._proxied&&this._proxied.play(a,b)},a.prototype.stop=function(a){var b=this._audioContext.currentTime;this._gain.gain.cancelScheduledValues(0),this._gain.gain.setValueAtTime(this._gain.gain.value,b),this._gain.gain.linearRampToValueAtTime(0,b+this.fadeTimeSeconds),this._proxied&&this._proxied.stop(a)},a.prototype.destroy=function(a){this._proxied&&this._proxied.destroy(a),this._gain.disconnect()},a.prototype.setPosition=function(a,b,c,d,e,f,g){var h=a*a+b*b,i=1-Math.sqrt(h)/g.maxRange,j=Math.pow(i,1.5),k=Math.atan2(b,a),l=Math.abs(Math.sin(Math.PI/4+k/2)),m=Math.abs(Math.sin(Math.PI/4-k/2));this._gainRight.gain.value=l*j,this._gainLeft.gain.value=m*j},a}();a.WebAudioManualPannerToneProxy=b}(a.Tone||(a.Tone={}));a.Tone}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){!function(a){var b=function(){function a(a,b,c,d,e,f){this.frequency=a,this.oscillatorType=b,this.lfoType=c,this.lfoFrequency=d,this.osciFOGain=e,this._audioContext=f,this._oscillator=f.createOscillator(),this._oscillator.frequency.value=a,this._oscillator.type=b,this._oscillator.noteOn(0),this._filter=f.createBiquadFilter(),this._filter.frequency.value=5e3,this._filter.type=0,this._oscillator.connect(this._filter),this._lfo=f.createOscillator(),this._lfo.type=c,this._lfo.frequency.value=d,this._lfo.noteOn(0),this._osciFOGain=f.createGainNode(),this._osciFOGain.gain.value=e,this._lfo.connect(this._osciFOGain),this._osciFOGain.connect(this._oscillator.detune)}return a.prototype.getSource=function(){return this._filter},a.prototype.setFilterFrequency=function(a){var b=this._audioContext.currentTime,c=40,d=22050,e=Math.log(d/c)/Math.LN2,f=Math.pow(2,e*(a-1));this._filter.frequency.setValueAtTime(d*f,b)},a.prototype.setFilterResonance=function(a){var b=this._audioContext.currentTime;this._filter.Q.setValueAtTime(30*a,b)},a.prototype.play=function(){},a.prototype.stop=function(){},a.prototype.destroy=function(){this._oscillator.noteOff(0),this._lfo.noteOff(0),this._filter.disconnect()},a.prototype.setPosition=function(){},a}();a.WebAudioSynthTone=b}(a.Tone||(a.Tone={}));a.Tone}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){var b=function(){function a(a){this._bars=a,this._uncontrolledMonsters=[]}return a.prototype.canAdd=function(a){var b,c=this._bars[a];if(null!=c){b=!1;for(var d in c.monsters){var e=c.monsters[d];if(null==e){b=!0;break}}}else b=!1;return b},a.prototype.add=function(a,b){var c=this._bars[a];if(null!=c)for(var d in c.monsters){var e=c.monsters[d];if(null==e){c.monsters[d]=b,d==c.index&&b.tone.play(0);break}}else b.tone.play(0),this._uncontrolledMonsters.push(b)},a.prototype.remove=function(a,b){var c=this._bars[a];if(null!=c){var d=c.monsters.indexOf(b);d>=0&&(b.tone.destroy(0),c.monsters[d]=null)}else{b.tone.destroy(0);var d=this._uncontrolledMonsters.indexOf(b);d>=0&&this._uncontrolledMonsters.splice(d,1)}},a.prototype.isPlaying=function(a,b){var c,d=this._bars[a];if(null!=d){var e=d.monsters.indexOf(b);c=e==d.index}else c=!1;return c},a.prototype.update=function(a,b){var c=b.getPlayer(),d=c.getX(),e=c.getY(),f=c.getZ(),g=c.getZAngle(),h=Math.sin(-g),i=Math.cos(-g);for(var j in this._bars){var k,l=this._bars[j],m=b.age%l.totalDuration,n=Math.ceil(m/l.toneDuration)%l.size;if(n!=l.index){var o=m%l.toneDuration,p=l.monsters[l.index];null!=p&&p.tone.stop(o),l.index=n,k=l.monsters[n],null!=k&&k.tone.play(o)}else k=l.monsters[n];if(null!=k){var q=k.getX()-d,r=k.getY()-e,s=q*i-r*h,t=q*h+r*i;k.tone.setPosition(s,t,f,0,0,0,b)}}for(var u in this._uncontrolledMonsters){var k=this._uncontrolledMonsters[u],q=k.getX()-d,r=k.getY()-e,s=q*i-r*h,t=q*h+r*i;k.tone.setPosition(s,t,f,0,0,0,b)}},a}();a.ToneSequencer=b}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){var b=function(){function a(a,b){this.size=a,this.toneDuration=b,this.monsters=[];for(var c=0;a>c;c++)this.monsters.push(null);this.index=null,this.totalDuration=b*a}return a}();a.ToneSequencerBar=b}(a.Play||(a.Play={}));a.Play}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){var b=function(){function a(a){var b=this;this._container=a,this._stateListener=function(a,c){a!=c&&b.setCurrentState(c)},window.onresize=function(){b._currentState&&b._currentState.requestLayout()}}return a.prototype.setCurrentState=function(a){var b=this;this._currentState&&(this._currentState.removeStateListener(this._stateListener),this._currentState.stop()),this._currentState=a,this._currentState&&(this._currentState.addStateListener(this._stateListener),this._currentState.init(this._container,function(){b._currentState.start()}))},a}();a.StateEngine=b}(a.State||(a.State={}));a.State}(GB||(GB={}));var GB;!function(a){!function(a){function b(a,b){return function(){return a.createTransformerFromString(b)}}a.createTransformerFactoryFromString=b}(a.Transformer||(a.Transformer={}));a.Transformer}(GB||(GB={}));var GB;!function(a){!function(a){!function(a){var b=function(){function a(a,b,c){this._xsltProcessor=a,this._toXMLTransformer=b,this._document=c}return a.prototype.setParameter=function(a,b){var c;if(b instanceof Array){c="";var d=!0;for(var e in b){var f=b[e];d?d=!1:c+=",",c+=f}}else c=b;this._xsltProcessor.setParameter(null,a,c)},a.prototype.transform=function(a,b,c){var d=this._toXMLTransformer(b);null==d&&(d=this._document.createElement("null"));var e=this._xsltProcessor.transformToFragment(d,this._document);a.appendChild(e),c&&c()},a}();a.StandardXSLTransformer=b}(a.XSL||(a.XSL={}));a.XSL}(a.Transformer||(a.Transformer={}));a.Transformer}(GB||(GB={}));var GB;!function(a){!function(b){!function(b){var c=function(){function b(a,b,c){this._domParser=a,this._document=b,this._toXMLTransformer=c}return b.prototype.preprocess=function(a,b,c){c()},b.prototype.createTransformerFromString=function(a){var b=this._domParser.parseFromString(a,"text/xml"),c=this.createTransformerFromNode(b);return c},b.prototype.createTransformerFromNode=function(b){var c=new XSLTProcessor;return c.importStylesheet(b),new a.Transformer.XSL.StandardXSLTransformer(c,this._toXMLTransformer,this._document)},b}();b.StandardXSLTransformerFactory=c}(b.XSL||(b.XSL={}));b.XSL}(a.Transformer||(a.Transformer={}));a.Transformer}(GB||(GB={}));var GB;!function(a){!function(a){function b(a,b){for(var c=!1,d=b.length;d>0;){d--;var e=b[d];if(e==a){b.splice(d,1),c=!0;break}}return c}a.removeFromArray=b}(a.Util||(a.Util={}));a.Util}(GB||(GB={}));var GB;!function(a){!function(a){function b(a){var b=/function (.{1,})\(/,c=b.exec(a.constructor.toString());return c&&c.length>1?c[1]:null}a.getClassName=b}(a.Util||(a.Util={}));a.Util}(GB||(GB={}));var GB;!function(a){!function(b){function c(a,b,c){var d=new XMLHttpRequest;d.onload=function(){b(d.responseXML)},d.onerror=function(a){c(a)},d.open("GET",a,!0),d.send(null)}function d(b,c,e,f,g,h,i,j){null==c&&null!=b&&(c=a.Util.getClassName(b));var k,l=typeof b,m="function"==l;if(null==c||m)k=null;else{var n=b instanceof Array,o="number"==l||"string"==l||"boolean"==l,p="undefined"==l&&!n,q=!n||null!=j;if(null==g&&(g="	"),null==h&&(h=""),k=h,q&&(k+="<"+c,null!=i&&null!=f)){var r=f[c];if(null!=r&&r.length>j){var s=r[j];k+=" "+s+'="'+i+'"'}}if(p)k+="/>\n";else{if(q&&(k+=">"),o)k+=b;else{k+="\n",null==j?j=0:j++;for(var t in b)if(null==e||e(b,t)){var u,v=b[t];if(n)u=d(v,c,e,f,g,h+g,t,j);else if("prototype"!=t){var w=t;0==w.indexOf("_")&&(w=w.substring(1)),u=d(v,w,e,f,g,h+g)}else u=null;null!=u&&(k+=u)}k+=h}q&&(k+="</"+c+">\n")}}return k}b.readXML=c,b.toXML=d}(a.Util||(a.Util={}));a.Util}(GB||(GB={})),window.onload=function(){window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)}),window.cancelAnimationFrame||(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(a){return window.clearTimeout(a)});var a;window.AudioContext?a=new AudioContext:window.webkitAudioContext&&(a=new webkitAudioContext);var b=new DOMParser,c=function(a){var c,d=GB.Util.toXML(a);return c=null!=d?b.parseFromString(d,"text/xml"):null},d=new GB.Transformer.XSL.StandardXSLTransformerFactory(b,document,c),e=document.getElementById("play-template").innerHTML,f=GB.Transformer.createTransformerFactoryFromString(d,e)(),g=1e3,h=g,i=function(){var b=h/8e3,c=h/1e3,d=h/1e3,e=a.createOscillator();e.frequency.value=100;var f=a.createJavaScriptNode(1024,1,1);f.onaudioprocess=function(a){for(var b=a.outputBuffer.getChannelData(0),c=0;c<b.length;c++)b[c]=2*Math.random()-1},e.connect(f);var g=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(b,1,c,0,d,a,f);return g.getSource().connect(a.destination),g},j=g,k=function(){try{var b=.1,c=j/1e3,d=.2,e=50*Math.random()+350,f=6.19,g=-500,h=.8,i=.38,k=new GB.State.Play.Tone.WebAudioSynthTone(e,2,2,f,g,a);
k.setFilterFrequency(h),k.setFilterResonance(i);var l=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(b,.3,c,.25,d,a,k.getSource(),k);return l.getSource().connect(a.destination),l}catch(m){return window.alert(""+m),null}},l=g,m=function(){var b=l/4e3,c=l/1e3,d=l/4e3,e=50*Math.random()+200,f=3.19,g=-500,h=1,i=.38,j=new GB.State.Play.Tone.WebAudioSynthTone(e,0,0,f,g,a);j.setFilterFrequency(h),j.setFilterResonance(i);var k=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(b,1,c,.9,d,a,j.getSource(),j);return k.getSource().connect(a.destination),k},n=1.5*g,o=function(){var b=n/4e3,c=n/1e3,d=n/4e3,e=50*Math.random()+100,f=9.19,g=-500,h=.5,i=.2,j=new GB.State.Play.Tone.WebAudioSynthTone(e,3,2,f,g,a);j.setFilterFrequency(h),j.setFilterResonance(i);var k=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(b,1,c,.9,d,a,j.getSource(),j);return k.getSource().connect(a.destination),k},p=.33*g,q=function(){var b=p/4e3,c=p/1e3,d=p/4e3,e=100*Math.random()+800,f=15,g=-500,h=.5,i=.2,j=new GB.State.Play.Tone.WebAudioSynthTone(e,3,2,f,g,a);j.setFilterFrequency(h),j.setFilterResonance(i);var k=new GB.State.Play.Tone.WebAudioManualPannerToneProxy(b,1,c,.9,d,a,j.getSource(),j);return k.getSource().connect(a.destination),k},r=function(b,c){var d=new GB.State.Play.Mind.ExplosionMind(h,30),e=function(a,b,c,e){var f=new GB.State.Play.Monster(d,i(),GB.State.Play.PlayState.MONSTER_TYPE_EXPLOSION,GB.State.Play.PlayState.MONSTER_TYPE_EXPLOSION_SUBTYPE_NORMAL,GB.State.Play.PlayState.MONSTER_STATE_NORMAL,a,b,c,e,0);return f},r=new GB.State.Play.Mind.DummyMind(e,2e3,1e3,.002),s=new GB.State.Play.Mind.CreeperMind(e,2e3,1e3,.003),t=new GB.State.Play.Mind.BulletMind(0,0,.1),u=function(a,b,c,d){var e=new GB.State.Play.Monster(t,k(),GB.State.Play.PlayState.MONSTER_TYPE_BULLET,GB.State.Play.PlayState.MONSTER_TYPE_BULLET_SUBTYPE_NORMAL,GB.State.Play.PlayState.MONSTER_STATE_NORMAL,a,b,c,d,3);return e},v=new GB.State.Play.Mind.PlayerMind(u),w=function(a){var b=[];b.push(new GB.State.Play.Spawner.RandomSpawnerWeight(40,4,1,GB.State.Play.PlayState.MONSTER_TYPE_CREEPER,GB.State.Play.PlayState.MONSTER_TYPE_CREEPER_SUBTYPE_NORMAL,function(){return s},o)),b.push(new GB.State.Play.Spawner.RandomSpawnerWeight(20,6,1,GB.State.Play.PlayState.MONSTER_TYPE_DUMMY,GB.State.Play.PlayState.MONSTER_TYPE_DUMMY_SUBTYPE_NORMAL,function(){return r},m)),b.push(new GB.State.Play.Spawner.RandomSpawnerWeight(10,10,1,GB.State.Play.PlayState.MONSTER_TYPE_SPINNER,GB.State.Play.PlayState.MONSTER_TYPE_SPINNER_SUBTYPE_NORMAL,function(){return new GB.State.Play.Mind.SpinningMind(e,2e3,1e3,.01,.001,Math.random()>.5)},q));var c=new GB.State.Play.Spawner.RandomSpawner(10,70,95,b),d={};d[GB.State.Play.PlayState.MONSTER_TYPE_DUMMY]=new GB.State.Play.ToneSequencerBar(2,l),d[GB.State.Play.PlayState.MONSTER_TYPE_BULLET]=new GB.State.Play.ToneSequencerBar(1,j),d[GB.State.Play.PlayState.MONSTER_TYPE_CREEPER]=new GB.State.Play.ToneSequencerBar(4,n),d[GB.State.Play.PlayState.MONSTER_TYPE_SPINNER]=new GB.State.Play.ToneSequencerBar(1,p);var f=new GB.State.Play.Level(100,c,a,new GB.State.Play.ToneSequencer(d));return f},x=new GB.State.Play.Monster(v,new GB.State.Play.Tone.NoTone(g),GB.State.Play.PlayState.MONSTER_TYPE_PLAYER,GB.State.Play.PlayState.MONSTER_TYPE_PLAYER_SUBTYPE_P1,GB.State.Play.PlayState.MONSTER_STATE_NORMAL,0,0,0,0,5),y=new GB.State.Play.PlayState(f,c,6,w,x,b,a);return y},s=document.getElementById("home-template").innerHTML,t=GB.Transformer.createTransformerFactoryFromString(d,s)(),u=new GB.State.Home.HomeState(t,r,a),v=document.getElementById("content"),w=new GB.State.StateEngine(v);w.setCurrentState(u)};